name: Satellite 1

on:
  schedule:
    # 6 sessions/day: 3 sat_boost + 3 sat_background
    - cron: '30 2 * * *'   # 08:00 IST — sat_background
    - cron: '30 5 * * *'   # 11:00 IST — sat_boost
    - cron: '30 8 * * *'   # 14:00 IST — sat_background
    - cron: '30 11 * * *'  # 17:00 IST — sat_boost
    - cron: '30 14 * * *'  # 20:00 IST — sat_boost (after main publish)
    - cron: '30 16 * * *'  # 22:00 IST — sat_background

  workflow_dispatch:
    inputs:
      session:
        description: 'Session type'
        required: true
        default: 'sat_boost'
        type: choice
        options: [sat_boost, sat_background]

concurrency:
  group: satellite-1
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env
        run: echo "${{ secrets.DOTENV_SAT1 }}" > instagram_influencer/.env

      - name: Seed session from secret
        run: |
          if [ -n "$SESS_B64" ]; then
            mkdir -p instagram_influencer/data/sat1
            echo "$SESS_B64" | base64 -d > instagram_influencer/data/sat1/.ig_session.json
          fi
        env:
          SESS_B64: ${{ secrets.INSTAGRAM_SESSION_B64_SAT1 }}

      - name: Determine session
        id: session
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.session }}" >> $GITHUB_OUTPUT
          else
            CRON="${{ github.event.schedule }}"
            case "${CRON}" in
              "30 2 * * *")  echo "type=sat_background" >> $GITHUB_OUTPUT ;;
              "30 5 * * *")  echo "type=sat_boost"      >> $GITHUB_OUTPUT ;;
              "30 8 * * *")  echo "type=sat_background" >> $GITHUB_OUTPUT ;;
              "30 11 * * *") echo "type=sat_boost"      >> $GITHUB_OUTPUT ;;
              "30 14 * * *") echo "type=sat_boost"      >> $GITHUB_OUTPUT ;;
              "30 16 * * *") echo "type=sat_background" >> $GITHUB_OUTPUT ;;
              *)             echo "type=sat_boost"      >> $GITHUB_OUTPUT ;;
            esac
          fi

      - name: Show session info
        run: |
          echo "Session: ${{ steps.session.outputs.type }}"
          echo "Trigger: ${{ github.event_name }}"

      - name: Run satellite
        id: bot
        continue-on-error: true
        run: |
          cd instagram_influencer
          python orchestrator.py --session ${{ steps.session.outputs.type }} --no-publish --no-generate

      - name: Check result
        if: steps.bot.outcome == 'failure'
        run: echo "::warning::Satellite 1 run failed"

      - name: Commit state
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f instagram_influencer/data/sat1/engagement_log.json 2>/dev/null || true
          git diff --staged --quiet || (
            git commit -m "bot: sat1 state $(date -u +%Y-%m-%dT%H:%M:%SZ) [${{ steps.session.outputs.type }}]"
            git pull --rebase origin main || true
            git push
          )

name: Instagram Bot (Maya)

on:
  schedule:
    # All cron times in UTC. IST = UTC + 5:30
    # Strategy: packed IG engagement — many small sessions = human phone-check pattern
    # 1 post/day at prime time (publishes to both IG + YT) + engagement spread throughout
    # Each session has 0-4min startup jitter built into the code
    #
    # PARALLEL: YouTube engagement runs on a SEPARATE workflow (youtube-bot.yml)
    # so IG and YT never block each other.
    #
    # OVERNIGHT — lighter sessions every ~90 min (00:00-06:00 IST)
    - cron: '30 18 * * *'  # 00:00 IST — explore (late night scroll)
    - cron: '0 20 * * *'   # 01:30 IST — warm_audience
    - cron: '30 21 * * *'  # 03:00 IST — hashtags
    - cron: '0 23 * * *'   # 04:30 IST — explore
    - cron: '30 0 * * *'   # 06:00 IST — warm_audience (early morning)
    #
    # DAYTIME — ~28 IG sessions, 07:00 to 23:15 IST, every 30-45 min
    - cron: '30 1 * * *'   # 07:00 IST — morning engagement (wake up)
    - cron: '10 2 * * *'   # 07:40 IST — explore (morning scroll)
    - cron: '45 2 * * *'   # 08:15 IST — warm_audience (high-ROI targeting)
    - cron: '20 3 * * *'   # 08:50 IST — hashtags
    - cron: '0 4 * * *'    # 09:30 IST — replies
    - cron: '35 4 * * *'   # 10:05 IST — stories
    - cron: '10 5 * * *'   # 10:40 IST — explore
    - cron: '45 5 * * *'   # 11:15 IST — hashtags
    - cron: '20 6 * * *'   # 11:50 IST — warm_audience (pre-lunch targeting)
    - cron: '0 7 * * *'    # 12:30 IST — explore (lunch scroll)
    - cron: '35 7 * * *'   # 13:05 IST — hashtags
    - cron: '10 8 * * *'   # 13:40 IST — replies
    - cron: '45 8 * * *'   # 14:15 IST — warm_audience (afternoon targeting)
    - cron: '20 9 * * *'   # 14:50 IST — explore
    - cron: '0 10 * * *'   # 15:30 IST — hashtags
    - cron: '40 10 * * *'  # 16:10 IST — stories
    - cron: '15 11 * * *'  # 16:45 IST — explore
    - cron: '50 11 * * *'  # 17:20 IST — warm_audience
    - cron: '30 12 * * *'  # 18:00 IST — hashtags
    - cron: '5 13 * * *'   # 18:35 IST — stories
    - cron: '30 13 * * *'  # 19:00 IST — PUBLISH (videos pre-rendered, --no-generate)
    - cron: '10 14 * * *'  # 19:40 IST — hashtags (post-publish engagement boost)
    - cron: '30 14 * * *'  # 20:00 IST — boost (viral detection, 1hr after publish)
    - cron: '45 14 * * *'  # 20:15 IST — replies
    - cron: '20 15 * * *'  # 20:50 IST — explore (evening wind-down)
    - cron: '30 15 * * *'  # 21:00 IST — cross_promo (engage partner's latest post)
    - cron: '0 16 * * *'   # 21:30 IST — warm_audience
    - cron: '35 16 * * *'  # 22:05 IST — maintenance (unfollow + welcome DMs)
    - cron: '15 17 * * *'  # 22:45 IST — maintenance (second pass)
    - cron: '45 17 * * *'  # 23:15 IST — daily report

  workflow_dispatch:
    inputs:
      session:
        description: 'Session type'
        required: true
        default: 'full'
        type: choice
        options: [morning, replies, hashtags, explore, warm_audience, boost, maintenance, stories, cross_promo, report, full, yt_engage, yt_replies, yt_full]
      publish:
        description: 'Also publish a post?'
        type: boolean
        default: false

# IG sessions queue behind each other (YT runs independently on youtube-bot.yml)
concurrency:
  group: instagram-bot-maya
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      # Restore Instagram session from cache (avoids re-login each run)
      - name: Restore session cache
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: instagram_influencer/data/maya/.ig_session.json
          key: ig-session-maya
          restore-keys: ig-session-maya

      # Seed session from secret if no cache was restored
      - name: Seed session from secret
        run: |
          mkdir -p instagram_influencer/data/maya
          if [ -f instagram_influencer/data/maya/.ig_session.json ]; then
            echo "Session restored from cache"
          elif [ -n "$SESS_B64" ]; then
            echo "$SESS_B64" | base64 -d > instagram_influencer/data/maya/.ig_session.json
            echo "Seeded session from secret"
          else
            echo "WARNING: No session available — bot will attempt fresh login"
          fi
        env:
          SESS_B64: ${{ secrets.INSTAGRAM_SESSION_B64 }}

      # Create .env from the DOTENV secret (includes PERSONA=maya)
      - name: Create .env
        run: |
          echo "${{ secrets.DOTENV }}" > instagram_influencer/.env
          grep -q "^PERSONA=" instagram_influencer/.env || echo "PERSONA=maya" >> instagram_influencer/.env
          # Also export PERSONA to the environment for reliability
          echo "PERSONA=maya" >> $GITHUB_ENV

      # Determine which session to run based on the trigger
      # IMPORTANT: Uses github.event.schedule (the exact cron expression) instead of
      # wall-clock time. GitHub Actions cron can delay 10-20+ minutes, so checking
      # `date` would misroute sessions.
      - name: Determine session
        id: session
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.session }}" >> $GITHUB_OUTPUT
            PUBLISH="${{ inputs.publish }}"
            echo "publish=${PUBLISH}" >> $GITHUB_OUTPUT
          else
            # Scheduled run — map exact cron expression to session type
            CRON="${{ github.event.schedule }}"
            case "${CRON}" in
              # Overnight sessions (00:00-06:00 IST)
              "30 18 * * *")  echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 20 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 21 * * *")  echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 23 * * *")   echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 0 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              # Daytime sessions (07:00-23:15 IST)
              "30 1 * * *")   echo "type=morning"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "10 2 * * *")   echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "45 2 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "20 3 * * *")   echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 4 * * *")    echo "type=replies"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "35 4 * * *")   echo "type=stories"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "10 5 * * *")   echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "45 5 * * *")   echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "20 6 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 7 * * *")    echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "35 7 * * *")   echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "10 8 * * *")   echo "type=replies"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "45 8 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "20 9 * * *")   echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 10 * * *")   echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "40 10 * * *")  echo "type=stories"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "15 11 * * *")  echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "50 11 * * *")  echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 12 * * *")  echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "5 13 * * *")   echo "type=stories"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 13 * * *")  echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=true"  >> $GITHUB_OUTPUT ;;
              "10 14 * * *")  echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 14 * * *")  echo "type=boost"          >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "45 14 * * *")  echo "type=replies"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "20 15 * * *")  echo "type=explore"        >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "30 15 * * *")  echo "type=cross_promo"    >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "0 16 * * *")   echo "type=warm_audience"  >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "35 16 * * *")  echo "type=maintenance"    >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "15 17 * * *")  echo "type=maintenance"    >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              "45 17 * * *")  echo "type=report"         >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
              *)              echo "type=hashtags"       >> $GITHUB_OUTPUT; echo "publish=false" >> $GITHUB_OUTPUT ;;
            esac
          fi

      - name: Show session info
        run: |
          echo "Session: ${{ steps.session.outputs.type }}"
          echo "Publish: ${{ steps.session.outputs.publish }}"
          echo "Trigger: ${{ github.event_name }}"

      # Run the bot (continue-on-error so state still gets committed)
      # Videos are pre-rendered locally/manually — always pass --no-generate
      # Only the publish session gets to publish; all others are engagement-only
      - name: Run bot
        id: bot
        continue-on-error: true
        run: |
          cd instagram_influencer
          FLAGS="--session ${{ steps.session.outputs.type }} --no-generate"
          if [ "${{ steps.session.outputs.publish }}" = "false" ]; then
            FLAGS="$FLAGS --no-publish"
          fi
          echo "Running: python orchestrator.py $FLAGS"
          python orchestrator.py $FLAGS

      - name: Check bot result
        if: steps.bot.outcome == 'failure'
        run: echo "::warning::Bot run failed — check logs above"

      # Save updated session to cache
      - name: Save session cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: instagram_influencer/data/maya/.ig_session.json
          key: ig-session-maya-${{ github.run_id }}

      # Commit updated state files + session back to the repo
      - name: Commit state
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Add each file individually to avoid one missing file blocking all staging
          for f in \
            instagram_influencer/data/maya/engagement_log.json \
            instagram_influencer/data/maya/followers.json \
            instagram_influencer/data/maya/content_queue.json \
            instagram_influencer/data/maya/highlights.json \
            instagram_influencer/data/maya/daily_report.md \
            instagram_influencer/data/maya/.ig_session.json; do
            [ -f "$f" ] && git add -f "$f" 2>/dev/null || true
          done
          [ -f "instagram_influencer/data/maya/generated_images/IMAGE_PROMPTS.md" ] && \
            git add -f "instagram_influencer/data/maya/generated_images/IMAGE_PROMPTS.md" 2>/dev/null || true
          [ -d "instagram_influencer/data/maya/generated_images/pending" ] && \
            git add -f "instagram_influencer/data/maya/generated_images/pending/" 2>/dev/null || true
          git diff --staged --quiet || (
            git commit -m "bot: maya state update $(date -u +%Y-%m-%dT%H:%M:%SZ) [${{ steps.session.outputs.type }}]"
            for attempt in 1 2 3; do
              git pull --rebase origin main 2>/dev/null && git push && break
              echo "Push attempt $attempt failed, retrying..."
              sleep 2
            done
          )
